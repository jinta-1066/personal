<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Sampler Pro</title>
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/1Spt9dvfuObJMFrv3fzAQMBeWfWkIn6VZ">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1Spt9dvfuObJMFrv3fzAQMBeWfWkIn6VZ">
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1Spt9dvfuObJMFrv3fzAQMBeWfWkIn6VZ">
    <!-- Ver.4.6 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Base Styles --- */
        body { background-color: #ffffff; color: #333; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; user-select: none; }
        
        /* --- Screen Size Blocker (520x360) --- */
        #size-warning { display: none; }
        @media (max-width: 519px), (max-height: 359px) { #size-warning { display: flex !important; } }

        /* --- UI Components --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #22c55e; margin-top: -5px; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; }
        
        /* Vertical Slider (EQ) */
        input[type=range].vertical-slider {
            -webkit-appearance: slider-vertical;
            writing-mode: bt-lr; 
            width: 8px;
            height: 100%; 
            padding: 0 5px;
            background: transparent;
            margin: 0 auto;
        }
        @supports not (-webkit-appearance: slider-vertical) {
            input[type=range].vertical-slider {
                -webkit-appearance: none;
                width: 100px;
                height: 8px;
                transform: rotate(-90deg);
                transform-origin: center;
                margin: 0;
            }
        }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; background: transparent; text-align: center; font-family: monospace; border: 1px solid #e2e8f0; border-radius: 4px; transition: all 0.2s; }
        input[type=number]:focus { border-color: #22c55e; background-color: #ffffff; outline: none; }

        .toggle-switch { width: 2.5rem; height: 1.25rem; border-radius: 9999px; position: relative; transition: background-color 0.2s; cursor: pointer; border: none; flex-shrink: 0; }
        .toggle-knob { width: 0.75rem; height: 0.75rem; background-color: white; border-radius: 50%; position: absolute; top: 0.25rem; left: 0.25rem; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .toggle-active { background-color: #22c55e; }
        .toggle-active-blue { background-color: #3b82f6; }
        .toggle-active-orange { background-color: #f97316; }
        .toggle-active-purple { background-color: #a855f7; }
        .toggle-inactive { background-color: #d1d5db; }
        .toggle-on .toggle-knob { transform: translateX(1.25rem); }

        /* --- Pad Styles --- */
        .pad-surface { transition: all 0.1s ease; position: relative; background-color: white; border: 3px solid #22c55e; border-radius: 8px; cursor: pointer; touch-action: manipulation; height: 100%; width: 100%; overflow: hidden; }
        .pad-surface:active { transform: scale(0.96); background-color: #f0fdf4; }
        .pad-surface.audible { border-color: #ec4899 !important; box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); background-color: #fff1f2; }
        .pad-surface.silenced { border-color: #eab308 !important; background-color: #fefce8; opacity: 0.9; }
        .pad-surface.locked { opacity: 0.6; background-color: #f3f4f6; cursor: not-allowed; border-color: #d1d5db !important; }
        
        .badge-container { position: absolute; top: 2px; left: 2px; display: flex; gap: 2px; z-index: 10; }
        .badge { font-size: 9px; padding: 1px 3px; border-radius: 2px; font-weight: bold; color: white; display: none; }
        .pad-surface.soloed .badge-solo { display: block; background-color: #3b82f6; }
        .pad-surface.effects-on .badge-effect { display: block; background-color: #8b5cf6; }

        /* Mode Buttons */
        .btn-mode-active { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); }
        .playmode-active { background-color: #22c55e !important; color: white !important; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .controls-disabled { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .layout-normal { flex-direction: row; }
        .layout-reverse { flex-direction: row-reverse; }
        .toast { transition: transform 0.3s, opacity 0.3s; transform: translateY(150%) translateX(-50%); opacity: 0; }
        .toast.show { transform: translateY(0) translateX(-50%); opacity: 1; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .eq-grid { background: linear-gradient(to bottom, #e5e7eb 1px, transparent 1px, transparent calc(25% - 1px), #e5e7eb 1px, transparent 1px, transparent calc(50% - 1px), #9ca3af 1px, transparent 1px, transparent calc(75% - 1px), #e5e7eb 1px, transparent 1px, transparent 100%); background-size: 100% 100%; }
        
        /* Effect Styles */
        .effect-group { border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; margin-bottom: 10px; background-color: #f9fafb; }
        .effect-header { font-size: 11px; font-weight: bold; color: #4b5563; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 z-[9999] bg-black bg-opacity-30 hidden flex items-center justify-center cursor-wait">
        <div class="bg-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3">
            <i class="fa-solid fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <span class="font-bold text-gray-700">Processing...</span>
        </div>
    </div>

    <div id="size-warning" class="fixed inset-0 bg-gray-800 z-[9999] flex flex-col items-center justify-center text-white p-6 text-center">
        <i class="fa-solid fa-display text-5xl mb-4 text-red-400"></i>
        <h2 class="text-2xl font-bold mb-2">Screen Size Too Small</h2>
        <p class="text-sm text-gray-400 mt-2">Minimum required: 520px x 360px</p>
        <button onclick="toggleFullscreen()" class="mt-6 px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold transition" id="warning-fs-btn">Enter Fullscreen</button>
    </div>

    <!-- App Container -->
    <div id="app-container" class="flex flex-grow w-full h-full layout-normal overflow-hidden">
        
        <!-- Pads Area -->
        <div class="flex-grow bg-white flex flex-col items-center justify-center p-3 h-full overflow-hidden">
            <div id="pads-grid" class="grid gap-3 w-full h-full max-w-6xl"></div>
        </div>

        <!-- Controls Area -->
        <div id="controls-area" class="w-64 min-w-[250px] bg-white border-l border-gray-200 flex flex-col justify-between p-4 shadow-xl z-20 relative h-full">
            
            <!-- Top Tools -->
            <div class="flex flex-col gap-4 w-full">
                <h1 class="text-xl font-bold text-gray-800 text-center tracking-tight border-b pb-3">Web Sampler Pro</h1>
                
                <div id="non-essential-controls" class="flex flex-col gap-4 transition-opacity duration-200">
                    <div id="top-tools" class="flex justify-center gap-3">
                        <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition shadow-sm" title="Settings"><i class="fa-solid fa-gear text-lg"></i></button>
                        <button onclick="toggleLayout()" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition shadow-sm" title="Swap Layout"><i class="fa-solid fa-arrow-right-arrow-left text-lg"></i></button>
                        <button onclick="toggleFullscreen()" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition shadow-sm" title="Fullscreen" id="panel-fs-btn"><i class="fa-solid fa-expand text-lg"></i></button>
                    </div>
                </div>
            </div>

            <!-- Bottom Controls -->
            <div class="flex flex-col gap-3 mt-auto pt-3 border-t border-gray-100">
                <div id="live-controls" class="grid grid-cols-3 gap-2 controls-disabled transition-opacity duration-200">
                    <button id="btn-mute-mode" onclick="toggleMuteMode()" class="py-3 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold text-xs transition border border-gray-200 shadow-sm">MUTE</button>
                    <button id="btn-solo-mode" onclick="toggleSoloMode()" class="py-3 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold text-xs transition border border-gray-200 shadow-sm">SOLO</button>
                    <button id="btn-end-mode" onclick="toggleEndMode()" class="py-3 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold text-xs transition border border-gray-200 shadow-sm">END</button>
                </div>

                <button onclick="stopAllSounds()" class="w-full py-3 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold shadow-md transition flex items-center justify-center gap-2 text-sm active:scale-95"><i class="fa-solid fa-square"></i> ALL STOP</button>

                <!-- Master Volume with Margin (Modified margin-bottom) -->
                <div class="border-b border-gray-200 pb-3 mb-3">
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-bold"><span>MASTER VOL</span><span id="master-vol-display">100%</span></div>
                    <input type="range" id="master-volume" min="0" max="200" value="100" oninput="updateMasterVolume(this.value)" class="w-full">
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white w-[95vw] max-w-5xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden animate-fade-in-up">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-700 flex items-center"><i class="fa-solid fa-sliders mr-2"></i> Pad Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex flex-grow overflow-hidden">
                <!-- Left List -->
                <div class="w-1/4 min-w-[200px] border-r bg-gray-50 overflow-y-auto p-3">
                    <div id="settings-pad-list" class="space-y-1"></div>
                </div>
                
                <!-- Right Config Area -->
                <div class="flex-grow p-8 overflow-y-auto relative bg-white">
                    
                    <!-- General Settings -->
                    <div id="general-config-area" class="hidden space-y-8">
                        <div>
                            <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">General Settings</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div class="bg-white p-5 rounded-lg border shadow-sm">
                                        <h4 class="text-sm font-bold text-gray-600 mb-3">Grid Layout</h4>
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-bold text-gray-500 uppercase">Rows (行)</span>
                                            <div class="flex items-center gap-2"><button onclick="updateGridDim('rows', -1)" class="w-7 h-7 rounded bg-gray-100 border flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-minus text-xs"></i></button><span id="disp-rows" class="text-sm font-bold w-8 text-center">4</span><button onclick="updateGridDim('rows', 1)" class="w-7 h-7 rounded bg-gray-100 border flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-plus text-xs"></i></button></div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs font-bold text-gray-500 uppercase">Cols (列)</span>
                                            <div class="flex items-center gap-2"><button onclick="updateGridDim('cols', -1)" class="w-7 h-7 rounded bg-gray-100 border flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-minus text-xs"></i></button><span id="disp-cols" class="text-sm font-bold w-8 text-center">4</span><button onclick="updateGridDim('cols', 1)" class="w-7 h-7 rounded bg-gray-100 border flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-plus text-xs"></i></button></div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-5 rounded-lg border shadow-sm">
                                        <h4 class="text-sm font-bold text-gray-600 mb-3">Data Management</h4>
                                        <div class="flex gap-3">
                                            <button onclick="exportData()" class="flex-1 py-2.5 bg-blue-50 text-blue-600 rounded text-xs hover:bg-blue-100 font-bold border border-blue-200 transition"><i class="fa-solid fa-download mr-2"></i> Export JSON</button>
                                            <button onclick="document.getElementById('import-file').click()" class="flex-1 py-2.5 bg-purple-50 text-purple-600 rounded text-xs hover:bg-purple-100 font-bold border border-purple-200 transition"><i class="fa-solid fa-upload mr-2"></i> Import JSON</button>
                                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white p-5 rounded-lg border shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-600 mb-3">Keyboard Control</h4>
                                    <div class="flex items-center justify-between mb-4"><span class="text-xs font-bold text-gray-500">Enable Shortcuts</span><div id="kb-toggle" onclick="toggleKeyboardControl()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                    <div class="text-xs text-gray-500 space-y-2 bg-gray-50 p-4 rounded border border-gray-100"><p class="font-bold text-gray-600 mb-2">Controls (Playing Only):</p><ul class="list-disc pl-4 space-y-1"><li>Shift: Mute</li><li>Ctrl: Solo</li><li>Alt: End</li><li>Space: Stop</li><li>Arrows: Volume</li></ul></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pad Settings -->
                    <div id="pad-config-area" class="hidden space-y-8">
                        <div class="flex justify-between items-center border-b pb-4">
                            <div><h3 id="config-pad-title" class="text-2xl font-bold text-green-600">Pad 1</h3><div class="flex items-center gap-2 mt-1"><span id="config-current-filename" class="text-xs text-gray-400 font-mono bg-gray-100 px-2 py-0.5 rounded">No file loaded</span></div></div>
                            <div class="flex items-center gap-6">
                                <div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-600">Key:</span><input type="text" id="config-keybind" maxlength="1" class="w-8 text-center uppercase font-bold text-sm border rounded outline-none focus:border-green-500" oninput="updatePadKeybind(this.value)" placeholder="-"></div>
                                <div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-600">Lock</span><div id="lock-toggle" onclick="togglePadLock()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-6">
                                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-700 uppercase mb-2">Source & Name</label><div class="flex items-center gap-3 mb-4"><label class="cursor-pointer bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold transition shadow-sm flex items-center hover:shadow"><i class="fa-solid fa-upload mr-2"></i> Upload (Max 50MB)<input type="file" accept="audio/*" class="hidden" onchange="handleAudioUpload(this)"></label><span id="upload-status" class="text-xs font-bold hidden bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Processing...</span></div><input type="text" id="config-name" oninput="updatePadName(this.value)" class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-green-500" placeholder="Enter Pad Name"></div>
                                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-gray-700 uppercase">Volume (%)</label></div><div class="flex items-center gap-3 mb-2"><button onclick="adjustPadVolume(-10)" class="w-8 h-8 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-minus text-xs"></i></button><input type="range" id="config-vol" min="0" max="200" value="100" oninput="updatePadVolume(this.value)" class="flex-grow h-2 bg-gray-200 rounded-lg cursor-pointer"><button onclick="adjustPadVolume(10)" class="w-8 h-8 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button><input type="number" id="config-vol-input" value="100" class="w-12 text-xs font-mono bg-white px-1 py-1 rounded border" onchange="updatePadVolume(this.value)"></div></div>
                                
                                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 space-y-5">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Play Mode</label>
                                        <div class="flex rounded-md border border-gray-300 bg-white overflow-hidden shadow-sm mb-3">
                                            <button onclick="setPlayMode('poly')" id="mode-poly" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 border-r transition">Poly</button>
                                            <button onclick="setPlayMode('mono')" id="mode-mono" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 border-r transition">Mono</button>
                                            <button onclick="setPlayMode('solo')" id="mode-solo" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 transition">Solo</button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div class="flex flex-col items-center"><label class="text-[10px] font-bold text-gray-500 uppercase mb-1">Loop</label><div id="loop-toggle" onclick="togglePadLoop()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                            <div class="flex flex-col items-center"><label class="text-[10px] font-bold text-gray-500 uppercase mb-1">Rev</label><div id="reverse-toggle" onclick="togglePadReverse()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                            <div class="flex flex-col items-center"><label class="text-[10px] font-bold text-gray-500 uppercase mb-1">Stop</label><div id="toggle-play-toggle" onclick="togglePadToggleMode()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                            <div class="flex flex-col items-center"><label class="text-[10px] font-bold text-gray-500 uppercase mb-1">Hold</label><div id="hold-toggle" onclick="togglePadHoldMode()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div><div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-700 uppercase">Speed (x)</label></div><div class="flex items-center gap-2"><button onclick="adjustPadBpm(-0.05)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-minus text-[10px]"></i></button><input type="range" id="config-bpm" min="0.1" max="2.0" step="0.05" value="1.0" oninput="updatePadBpm(this.value)" class="flex-grow h-1.5 bg-gray-200 rounded-lg cursor-pointer"><button onclick="adjustPadBpm(0.05)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-plus text-[10px]"></i></button><input type="number" id="config-bpm-input" value="1.00" step="0.05" class="w-16 text-xs font-mono bg-white px-1 py-1 rounded border" onchange="updatePadBpm(this.value)"></div></div>
                                        <div><div class="flex justify-between items-center mb-1"><label class="text-xs font-bold text-gray-700 uppercase">Pitch (Semi)</label></div><div class="flex items-center gap-2"><button onclick="adjustPadPitch(-0.20)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-minus text-[10px]"></i></button><input type="range" id="config-pitch" min="-12" max="12" step="0.20" value="0" oninput="updatePadPitch(this.value)" class="flex-grow h-1.5 bg-gray-200 rounded-lg cursor-pointer"><button onclick="adjustPadPitch(0.20)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-plus text-[10px]"></i></button><input type="number" id="config-pitch-input" value="0.00" step="0.20" class="w-16 text-xs font-mono bg-white px-1 py-1 rounded border" onchange="updatePadPitch(this.value)"></div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200"><label class="block text-xs font-bold text-gray-700 uppercase mb-2">Trimming (MM:SS.mmm)</label><div class="flex gap-4"><div class="flex-1"><span class="text-[10px] text-gray-500 font-bold block mb-1">Start</span><input type="text" id="trim-start" placeholder="0:00.000" onchange="updateTrim()" class="w-full border border-gray-300 rounded px-2 py-1.5 text-center font-mono text-sm focus:border-green-500 outline-none"></div><div class="flex-1"><span class="text-[10px] text-gray-500 font-bold block mb-1">End</span><input type="text" id="trim-end" placeholder="End" onchange="updateTrim()" class="w-full border border-gray-300 rounded px-2 py-1.5 text-center font-mono text-sm focus:border-green-500 outline-none"></div></div></div>
                                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-4"><label class="text-xs font-bold text-gray-700 uppercase">9-Band EQ</label><button id="eq-toggle" onclick="toggleEq()" class="text-[10px] px-3 py-1 rounded-full bg-gray-300 text-white font-bold transition">OFF</button></div>
                                    <div class="relative h-40 w-full"><div class="absolute left-0 top-0 h-full flex flex-col justify-between text-[9px] text-gray-400 font-mono pointer-events-none pr-1 w-8 text-right z-10"><span>+20</span><span>+10</span><span>0dB</span><span>-10</span><span>-20</span></div><div id="eq-container" class="ml-8 grid grid-cols-9 gap-1 h-full items-end opacity-40 pointer-events-none transition-opacity eq-grid relative border border-gray-200 bg-white rounded"></div></div><div id="eq-labels" class="ml-8 grid grid-cols-9 gap-1 mt-1 text-center"></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between border-b pb-2 mb-3"><h4 class="text-sm font-bold text-purple-600 uppercase">Sound Effects</h4><div id="effect-pad-toggle" onclick="togglePadEffectState()" class="toggle-switch toggle-inactive"><div class="toggle-knob"></div></div></div>
                                    <div id="effects-container" class="opacity-50 pointer-events-none transition-opacity space-y-3 h-[450px] overflow-y-auto pr-2">
                                        <!-- FX (Ver 4.2 Size) -->
                                        <div class="effect-group"><div class="effect-header"><span>Filter / Resonance</span><button id="filter-type-btn" class="text-[10px] bg-white border px-2 py-0.5 rounded shadow-sm hover:bg-gray-50" onclick="toggleFilterType()">LowPass</button></div><div class="grid grid-cols-2 gap-3"><div><div class="flex justify-between text-[11px] mb-1 font-medium text-gray-600"><span>Freq</span><input type="number" id="fx-cutoff-val" class="w-14 p-1 text-right border rounded bg-white text-xs" onchange="updateFx('cutoff', this.value)"></div><input type="range" id="fx-cutoff" min="20" max="20000" step="10" oninput="updateFx('cutoff', this.value)" class="h-2 bg-gray-300 rounded w-full"></div><div><div class="flex justify-between text-[11px] mb-1 font-medium text-gray-600"><span>Res</span><input type="number" id="fx-res-val" class="w-12 p-1 text-right border rounded bg-white text-xs" onchange="updateFx('res', this.value)"></div><input type="range" id="fx-res" min="0" max="100" step="5" oninput="updateFx('res', this.value)" class="h-2 bg-gray-300 rounded w-full"></div></div></div>
                                        <div class="effect-group"><div class="effect-header"><span>Drive</span></div><div class="flex items-center gap-3"><input type="range" id="fx-drive" min="0" max="100" step="5" oninput="updateFx('drive', this.value)" class="h-2 bg-gray-300 rounded flex-grow"><input type="number" id="fx-drive-val" class="w-14 text-xs p-1 border rounded bg-white text-center" onchange="updateFx('drive', this.value)"></div></div>
                                        <div class="effect-group"><div class="effect-header"><span>Compressor</span></div><div class="grid grid-cols-2 gap-3 text-[11px] font-medium text-gray-600"><div class="flex justify-between items-center">Thresh: <input type="number" id="fx-comp-thresh-val" class="w-12 p-1 border rounded bg-white text-right text-xs" onchange="updateFx('compThresh', this.value)"> dB</div><div class="flex justify-between items-center">Ratio: <input type="number" id="fx-comp-ratio-val" class="w-12 p-1 border rounded bg-white text-right text-xs" onchange="updateFx('compRatio', this.value)"> :1</div><div class="flex justify-between items-center">Att: <input type="number" id="fx-comp-att-val" class="w-12 p-1 border rounded bg-white text-right text-xs" onchange="updateFx('compAtt', this.value)"> ms</div><div class="flex justify-between items-center">Rel: <input type="number" id="fx-comp-rel-val" class="w-12 p-1 border rounded bg-white text-right text-xs" onchange="updateFx('compRel', this.value)"> ms</div></div></div>
                                        <div class="effect-group"><div class="effect-header"><span>Delay</span></div><div class="space-y-3"><div class="flex items-center justify-between text-[11px] font-medium text-gray-600"><span>Time (s)</span><div class="flex items-center gap-2"><input type="range" id="fx-delay-time" min="0" max="1" step="0.01" class="w-28 h-2 bg-gray-300 rounded" oninput="updateFx('delayTime', this.value)"><input type="number" id="fx-delay-time-val" class="w-14 p-1 border rounded bg-white text-xs text-center" onchange="updateFx('delayTime', this.value)"></div></div><div class="flex items-center justify-between text-[11px] font-medium text-gray-600"><span>Feed %</span><div class="flex items-center gap-2"><input type="range" id="fx-delay-feed" min="0" max="99" step="5" class="w-28 h-2 bg-gray-300 rounded" oninput="updateFx('delayFeed', this.value)"><input type="number" id="fx-delay-feed-val" class="w-14 p-1 border rounded bg-white text-xs text-center" onchange="updateFx('delayFeed', this.value)"></div></div><div class="flex items-center justify-between text-[11px] font-medium text-gray-600"><span>Mix %</span><div class="flex items-center gap-2"><input type="range" id="fx-delay-mix" min="0" max="100" step="5" class="w-28 h-2 bg-gray-300 rounded" oninput="updateFx('delayMix', this.value)"><input type="number" id="fx-delay-mix-val" class="w-14 p-1 border rounded bg-white text-xs text-center" onchange="updateFx('delayMix', this.value)"></div></div></div></div>
                                        <div class="effect-group"><div class="effect-header"><span>Reverb</span></div><div class="flex items-center justify-between text-[11px] font-medium text-gray-600"><span>Mix (0-1)</span><div class="flex items-center gap-2"><input type="range" id="fx-reverb" min="0" max="1" step="0.05" class="w-28 h-2 bg-gray-300 rounded" oninput="updateFx('reverb', this.value)"><input type="number" id="fx-reverb-val" class="w-14 p-1 border rounded bg-white text-xs text-center" onchange="updateFx('reverb', this.value)"></div></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="config-empty" class="h-full flex flex-col items-center justify-center text-gray-300"><i class="fa-solid fa-arrow-left-long text-4xl mb-4"></i><p class="font-bold text-lg">Select Settings from List</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 toast font-bold text-sm pointer-events-none flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> <span id="toast-msg">Notification</span></div>

    <script>
        const FREQUENCIES = [62, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
        const MAX_PADS = 25; // 5x5
        const MAX_FILE_SIZE = 50 * 1024 * 1024;
        
        const state = {
            rows: 4, cols: 4, masterVolume: 100, isRightLayout: true,
            pads: [], activeAudioCount: 0, currentConfigId: null,
            isMuteMode: false, isSoloMode: false, isEndMode: false, isEffectMode: false,
            keyboardEnabled: false
        };

        let audioCtx = null;
        let masterGain = null;
        let impulseBuffer = null;

        const createPad = (id) => {
            let kb = null;
            if(id < 9) kb = (id + 1).toString();
            else if(id === 9) kb = '0';
            return {
                id, name: `Pad ${id + 1}`, buffer: null, rawBase64: null, fileName: "",
                volume: 100, playbackRate: 1.00, pitch: 0.00, loop: false, reverse: false, toggleMode: false, holdMode: false,
                isLocked: false, playMode: 'poly', trimStart: 0, trimEnd: null,
                activeSources: [], isMuted: false, isSoloed: false,
                keyBind: kb, eqEnabled: false, eqGains: new Array(9).fill(0), effectsEnabled: false,
                fx: { filterType: 'lowpass', cutoff: 20000, res: 0, drive: 0, compThresh: -24, compRatio: 4, compAtt: 10, compRel: 250, delayTime: 0.3, delayFeed: 0, delayMix: 0, reverb: 0 },
                _revBuffer: null
            };
        };

        for(let i=0; i<MAX_PADS; i++) state.pads.push(createPad(i));

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                updateMasterVolumeState();
                generateImpulseResponse();
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function generateImpulseResponse() {
            const rate = audioCtx.sampleRate;
            const length = rate * 2.0; 
            const decay = 2.0;
            const impulse = audioCtx.createBuffer(2, length, rate);
            const L = impulse.getChannelData(0);
            const R = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = i / length;
                L[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                R[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
            }
            impulseBuffer = impulse;
        }

        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = (i * 2) / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function handlePadDown(padId) {
            if (state.activeAudioCount === 0 && !state.isEffectMode) {
                playSound(padId); return;
            }
            const pad = state.pads[padId];
            const isPlaying = pad.activeSources.length > 0;

            if (state.isEndMode) { if(isPlaying) stopPad(padId); return; }
            if (state.isMuteMode) { if(isPlaying) togglePadMute(padId); return; }
            if (state.isEffectMode) { if(isPlaying) togglePadEffectActive(padId); return; }

            if (state.isSoloMode) {
                if (isPlaying) { togglePadSolo(padId); return; }
                if (state.pads.some(p => p.isSoloed)) breakSoloState();
            } else {
                if (pad.toggleMode && isPlaying) {
                    stopPad(padId);
                    return;
                }
                
                if (state.pads.some(p => p.isSoloed)) breakSoloState();
            }
            playSound(padId);
        }

        function handlePadUp(padId) {
            const pad = state.pads[padId];
            if (pad.holdMode) {
                stopPad(padId);
            }
        }

        async function playSound(padId) {
            initAudio();
            const pad = state.pads[padId];
            if (pad.isLocked || !pad.buffer) return;

            if (pad.playMode === 'solo') stopAllSounds();
            else if (pad.playMode === 'mono') stopPad(padId);

            let bufferToPlay = pad.buffer;
            if (pad.reverse) {
                if (!pad._revBuffer) {
                    const ab = pad.buffer;
                    const rb = audioCtx.createBuffer(ab.numberOfChannels, ab.length, ab.sampleRate);
                    for(let c=0; c<ab.numberOfChannels; c++){
                        const d = ab.getChannelData(c);
                        const rd = rb.getChannelData(c);
                        for(let i=0; i<ab.length; i++) rd[i] = d[ab.length - 1 - i];
                    }
                    pad._revBuffer = rb;
                }
                bufferToPlay = pad._revBuffer;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = bufferToPlay;
            source.loop = pad.loop;
            source.playbackRate.value = pad.playbackRate;
            source.detune.value = pad.pitch * 100;

            const padGain = audioCtx.createGain();
            padGain.gain.value = calculatePadVolume(pad);

            let inputNode = source;
            const nodes = []; 

            if (pad.effectsEnabled) {
                const fx = pad.fx;
                const filter = audioCtx.createBiquadFilter();
                filter.type = fx.filterType;
                filter.frequency.value = fx.cutoff;
                filter.Q.value = fx.res / 5;
                inputNode.connect(filter); inputNode = filter; nodes.push(filter);

                if (fx.drive > 0) {
                    const shaper = audioCtx.createWaveShaper();
                    shaper.curve = makeDistortionCurve(fx.drive * 4);
                    shaper.oversample = '4x';
                    inputNode.connect(shaper); inputNode = shaper; nodes.push(shaper);
                }

                const comp = audioCtx.createDynamicsCompressor();
                comp.threshold.value = fx.compThresh; comp.ratio.value = fx.compRatio;
                comp.attack.value = fx.compAtt / 1000; comp.release.value = fx.compRel / 1000;
                inputNode.connect(comp); inputNode = comp; nodes.push(comp);

                if (fx.delayMix > 0 && fx.delayTime > 0) {
                    const delayNode = audioCtx.createDelay(1.0);
                    delayNode.delayTime.value = fx.delayTime;
                    const feedback = audioCtx.createGain();
                    feedback.gain.value = fx.delayFeed / 100;
                    const delayGain = audioCtx.createGain();
                    delayGain.gain.value = fx.delayMix / 100;
                    const merge = audioCtx.createGain();
                    inputNode.connect(merge);
                    inputNode.connect(delayNode);
                    delayNode.connect(feedback); feedback.connect(delayNode);
                    delayNode.connect(delayGain); delayGain.connect(merge);
                    inputNode = merge;
                    nodes.push(delayNode, feedback, delayGain, merge);
                }

                if (fx.reverb > 0 && impulseBuffer) {
                    const convolver = audioCtx.createConvolver();
                    convolver.buffer = impulseBuffer;
                    const verbGain = audioCtx.createGain();
                    verbGain.gain.value = fx.reverb;
                    const dryGain = audioCtx.createGain();
                    dryGain.gain.value = 1 - (fx.reverb * 0.5);
                    const merge = audioCtx.createGain();
                    inputNode.connect(dryGain); dryGain.connect(merge);
                    inputNode.connect(convolver); convolver.connect(verbGain); verbGain.connect(merge);
                    inputNode = merge;
                    nodes.push(convolver, verbGain, dryGain, merge);
                }
            }

            FREQUENCIES.forEach((freq, idx) => {
                const filter = audioCtx.createBiquadFilter();
                if (idx === 0) filter.type = 'lowshelf';
                else if (idx === FREQUENCIES.length - 1) filter.type = 'highshelf';
                else filter.type = 'peaking';
                filter.frequency.value = freq;
                filter.Q.value = 1.0;
                filter.gain.value = pad.eqEnabled ? pad.eqGains[idx] : 0; 
                inputNode.connect(filter); inputNode = filter; nodes.push(filter);
            });

            inputNode.connect(padGain);
            padGain.connect(masterGain);

            const duration = pad.buffer.duration;
            let start = pad.trimStart || 0;
            let end = pad.trimEnd !== null ? pad.trimEnd : duration;
            if (end > duration) end = duration;
            if (start >= end) start = 0;

            if (pad.loop) {
                source.loopStart = start;
                source.loopEnd = end;
                source.start(0, start);
            } else {
                source.start(0, start, end - start);
            }

            const sourceObj = { source, padGain, nodes };
            pad.activeSources.push(sourceObj);
            updatePlayState(padId, true);

            source.onended = () => {
                pad.activeSources = pad.activeSources.filter(s => s !== sourceObj);
                try { source.disconnect(); padGain.disconnect(); nodes.forEach(n => n.disconnect()); } catch(e){}
                if (pad.activeSources.length === 0) updatePlayState(padId, false);
            };
        }

        function calculatePadVolume(pad) {
            if (pad.isMuted) return 0;
            if (state.pads.some(p => p.isSoloed) && !pad.isSoloed) return 0;
            return pad.volume / 100;
        }

        function updateAllGainsAndVisuals() {
            state.pads.forEach(p => {
                const v = calculatePadVolume(p);
                p.activeSources.forEach(s => { try{ s.padGain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.02); }catch(e){} });
                updatePadVisual(p.id);
            });
        }

        function stopPad(padId) {
            const pad = state.pads[padId];
            pad.activeSources.forEach(s => { try{ s.source.stop(); }catch(e){} });
            pad.activeSources = [];
            pad.isMuted = false; pad.isSoloed = false;
            updatePlayState(padId, false);
            updateAllGainsAndVisuals();
        }

        function stopAllSounds() {
            state.pads.forEach(p => {
                p.activeSources.forEach(s => { try{s.source.stop();}catch(e){} });
                p.activeSources = [];
                p.isMuted = false; p.isSoloed = false;
                
                const el = document.getElementById(`pad-surface-${p.id}`);
                if(el) el.className = "pad-surface flex flex-col justify-between p-2 relative" + (p.isLocked ? " locked" : "");
            });
            state.isMuteMode = false; state.isSoloMode = false; state.isEndMode = false; state.isEffectMode = false;
            state.activeAudioCount = 0;
            updateModeButtons(); updateControlsState(); 
        }

        function updatePlayState(padId, isPlaying) {
            state.activeAudioCount = state.pads.reduce((acc, p) => acc + p.activeSources.length, 0);
            updatePadVisual(padId);
            updateControlsState();
            if (state.activeAudioCount === 0) stopAllSounds();
        }

        function updatePadVisual(padId) {
            const pad = state.pads[padId];
            const el = document.getElementById(`pad-surface-${padId}`);
            if(!el) return;
            el.classList.remove('audible', 'silenced', 'soloed', 'muted', 'effects-on');
            if(pad.isSoloed) el.classList.add('soloed');
            if(pad.effectsEnabled) el.classList.add('effects-on');
            if(pad.activeSources.length > 0) {
                if(calculatePadVolume(pad) > 0) el.classList.add('audible');
                else el.classList.add('silenced');
            }
        }

        function updateControlsState() {
            const live = document.getElementById('live-controls');
            const topTools = document.getElementById('top-tools');
            if (state.activeAudioCount > 0) {
                live.classList.remove('controls-disabled');
                topTools.classList.add('controls-disabled');
            } else {
                live.classList.add('controls-disabled');
                topTools.classList.remove('controls-disabled');
            }
        }

        function updateMasterVolumeState() {
            if(masterGain) masterGain.gain.value = state.masterVolume / 100;
        }

        function toggleMuteMode() { if(state.activeAudioCount>0) { state.isMuteMode = !state.isMuteMode; resetOtherModes('mute'); updateModeButtons(); } }
        function toggleSoloMode() { if(state.activeAudioCount>0) { state.isSoloMode = !state.isSoloMode; resetOtherModes('solo'); updateModeButtons(); } }
        function toggleEndMode() { if(state.activeAudioCount>0) { state.isEndMode = !state.isEndMode; resetOtherModes('end'); updateModeButtons(); } }
        function toggleEffectMode() { if(state.activeAudioCount>0) { state.isEffectMode = !state.isEffectMode; resetOtherModes('effect'); updateModeButtons(); } }
        
        function resetOtherModes(active) {
            if(active !== 'mute') state.isMuteMode = false;
            if(active !== 'solo') state.isSoloMode = false;
            if(active !== 'end') state.isEndMode = false;
            if(active !== 'effect') state.isEffectMode = false;
        }

        function updateModeButtons() {
            const set = (id, active, effect) => {
                const b = document.getElementById(id);
                if(!b) return; // Should not happen but safe guard
                if(active) b.classList.add(effect ? 'btn-effect-active' : 'btn-mode-active');
                else b.classList.remove('btn-effect-active', 'btn-mode-active');
            };
            set('btn-mute-mode', state.isMuteMode);
            set('btn-solo-mode', state.isSoloMode);
            set('btn-end-mode', state.isEndMode);
            // Effect button removed from main panel, but mode logic remains for hotkey/future
        }

        function togglePadMute(padId) {
            const p = state.pads[padId];
            const anySolo = state.pads.some(x => x.isSoloed);
            if (p.isMuted || (anySolo && !p.isSoloed)) {
                if(anySolo) breakSoloState();
                p.isMuted = false;
            } else { p.isMuted = true; }
            updateAllGainsAndVisuals();
        }

        function togglePadSolo(padId) {
            const p = state.pads[padId];
            if (!p.isSoloed) {
                state.pads.forEach(x => x.isSoloed = false);
                p.isSoloed = true; p.isMuted = false;
            } else { p.isSoloed = false; }
            updateAllGainsAndVisuals();
        }

        function togglePadEffectActive(padId) {
            const pad = state.pads[padId];
            pad.effectsEnabled = !pad.effectsEnabled;
            updatePadVisual(padId);
        }

        function breakSoloState() {
            state.pads.forEach(p => {
                if (p.isSoloed) p.isSoloed = false;
                else if (p.activeSources.length > 0 && !p.isMuted) p.isMuted = true;
            });
            updateAllGainsAndVisuals();
        }

        function handleAudioUpload(input) {
            const file = input.files[0];
            const status = document.getElementById('upload-status');
            if(!file) return;
            if (file.size > MAX_FILE_SIZE) { alert("File size exceeds 50MB limit."); input.value = ""; return; }

            initAudio(); 
            
            const overlay = document.getElementById('processing-overlay');
            overlay.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const binary = e.target.result; 
                let b64 = '';
                const bytes = new Uint8Array(arrayBuffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) b64 += String.fromCharCode(bytes[i]);
                const base64 = btoa(b64);
                const bufferForDecode = arrayBuffer.slice(0);

                audioCtx.decodeAudioData(bufferForDecode, 
                    function(buffer) {
                        const pad = state.pads[state.currentConfigId];
                        pad.buffer = buffer;
                        pad.rawBase64 = base64;
                        pad.fileName = file.name;
                        pad.name = file.name.replace(/\.[^/.]+$/, "");
                        pad._revBuffer = null;

                        overlay.classList.add('hidden');
                        
                        renderSettingsList(); 
                        
                        // Force Update of Form Inputs Immediately
                        const nameInput = document.getElementById('config-name');
                        if(nameInput) nameInput.value = pad.name;
                        const filenameLabel = document.getElementById('config-current-filename');
                        if(filenameLabel) filenameLabel.innerText = pad.fileName;
                        
                        renderPads(); 
                        selectSettingsItem('pad', state.currentConfigId); // Re-trigger highlight logic

                        showToast("Loaded successfully!");
                    },
                    function(err) {
                        console.error(err);
                        alert("Audio decode failed.");
                        overlay.classList.add('hidden');
                    }
                );
            };
            reader.readAsArrayBuffer(file);
            input.value = "";
        }

        // --- Config UI ---
        function updatePadName(v) { if(state.currentConfigId!=null) { state.pads[state.currentConfigId].name=v; renderPads(); renderSettingsList(); } }
        function togglePadLock(){ 
            if(state.currentConfigId!=null) { 
                const pad = state.pads[state.currentConfigId]; 
                pad.isLocked = !pad.isLocked; 
                const b=document.getElementById('lock-toggle');
                if(pad.isLocked){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; }
                else{ b.classList.remove('toggle-active'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; }
                renderPads(); 
            } 
        }
        function updatePadKeybind(v){ if(state.currentConfigId!=null){ const val=v.toUpperCase().replace(/[^A-Z0-9]/g,''); state.pads[state.currentConfigId].keyBind=val; document.getElementById('config-keybind').value=val; } }
        function updateReverseUi(on){ const b=document.getElementById('reverse-toggle'); if(on){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active-blue'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; } else{ b.classList.remove('toggle-active-blue'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; } }
        function togglePadReverse(){ if(state.currentConfigId!=null){ const p=state.pads[state.currentConfigId]; p.reverse=!p.reverse; p._revBuffer=null; updateReverseUi(p.reverse); } }
        function updatePadVolume(v){ if(state.currentConfigId!=null){ let val=parseInt(v)||100; state.pads[state.currentConfigId].volume=val; document.getElementById('config-vol').value=val; document.getElementById('config-vol-input').value=val; } }
        function adjustPadVolume(d){ updatePadVolume(state.pads[state.currentConfigId].volume+d); }
        function updatePadBpm(v){ if(state.currentConfigId!=null){ let val=Math.max(0.1, Math.min(2.0, parseFloat(v)||1)); state.pads[state.currentConfigId].playbackRate=val; document.getElementById('config-bpm').value=val; document.getElementById('config-bpm-input').value=val.toFixed(2); } }
        function adjustPadBpm(d){ updatePadBpm(state.pads[state.currentConfigId].playbackRate+d); }
        function updatePadPitch(v){ if(state.currentConfigId!=null){ let val=Math.max(-12, Math.min(12, parseFloat(v)||0)); state.pads[state.currentConfigId].pitch=val; document.getElementById('config-pitch').value=val; document.getElementById('config-pitch-input').value=val.toFixed(2); } }
        function adjustPadPitch(d){ updatePadPitch(state.pads[state.currentConfigId].pitch+d); }
        function updateLoopUi(on){ const b=document.getElementById('loop-toggle'); if(on){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; } else{ b.classList.remove('toggle-active'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; } }
        function togglePadLoop(){ if(state.currentConfigId!=null){ let p=state.pads[state.currentConfigId]; p.loop=!p.loop; updateLoopUi(p.loop); } }
        function updateToggleModeUi(on){ const b=document.getElementById('toggle-play-toggle'); if(on){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active-orange'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; } else{ b.classList.remove('toggle-active-orange'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; } }
        function togglePadToggleMode(){ if(state.currentConfigId!=null){ let p=state.pads[state.currentConfigId]; p.toggleMode=!p.toggleMode; if(p.toggleMode){ p.holdMode=false; updateHoldModeUi(false); } updateToggleModeUi(p.toggleMode); } }
        
        function updateHoldModeUi(on){ const b=document.getElementById('hold-toggle'); if(on){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active-purple'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; } else{ b.classList.remove('toggle-active-purple'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; } }
        function togglePadHoldMode(){ if(state.currentConfigId!=null){ let p=state.pads[state.currentConfigId]; p.holdMode=!p.holdMode; if(p.holdMode){ p.toggleMode=false; updateToggleModeUi(false); } updateHoldModeUi(p.holdMode); } }
        
        function setPlayMode(m){ if(state.currentConfigId!=null){ state.pads[state.currentConfigId].playMode=m; ['poly','mono','solo'].forEach(x=>{ document.getElementById(`mode-${x}`).className=x===m?"flex-1 py-2 text-xs font-bold transition playmode-active shadow-inner":"flex-1 py-2 text-xs font-bold hover:bg-gray-50 border-r transition bg-white text-gray-600"; }); } }
        function formatTime(s){ if(s==null||isNaN(s))return""; const m=Math.floor(s/60); const sc=(s%60).toFixed(3).replace(/\.000$/,''); return `${m}:${sc<10?'0':''}${sc}`; }
        function updateTrim(){ if(state.currentConfigId!=null){ const p=state.pads[state.currentConfigId]; const s=document.getElementById('trim-start').value.split(':'); const e=document.getElementById('trim-end').value.split(':'); const parse=(arr)=>arr.length===2?parseFloat(arr[0])*60+parseFloat(arr[1]):parseFloat(arr[0]); p.trimStart=parse(s)||0; p.trimEnd=parse(e)||null; } }
        
        function updateEffectStateUi(on) { 
            const b=document.getElementById('effect-pad-toggle'); const c=document.getElementById('effects-container');
            if(on){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active-purple'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; c.classList.remove('opacity-50','pointer-events-none'); }
            else{ b.classList.remove('toggle-active-purple'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; c.classList.add('opacity-50','pointer-events-none'); }
        }
        function togglePadEffectState() { if(state.currentConfigId!=null){ const p=state.pads[state.currentConfigId]; p.effectsEnabled=!p.effectsEnabled; updateEffectStateUi(p.effectsEnabled); updatePadVisual(state.currentConfigId); } }
        
        // FX
        function updateFx(key, val) { if(state.currentConfigId!=null){ state.pads[state.currentConfigId].fx[key]=parseFloat(val); updateFxUi(state.pads[state.currentConfigId].fx); } }
        function updateFxUi(fx) { 
            const set=(id,v)=>{ const el=document.getElementById(id); if(el)el.value=v; };
            set('fx-cutoff',fx.cutoff); set('fx-cutoff-val',fx.cutoff); 
            set('fx-res',fx.res); set('fx-res-val',fx.res); 
            set('fx-drive',fx.drive); set('fx-drive-val',fx.drive);
            set('fx-comp-thresh-val',fx.compThresh); set('fx-comp-ratio-val',fx.compRatio); 
            set('fx-comp-att-val',fx.compAtt); set('fx-comp-rel-val',fx.compRel);
            set('fx-delay-time',fx.delayTime); set('fx-delay-time-val',fx.delayTime);
            set('fx-delay-feed',fx.delayFeed); set('fx-delay-feed-val',fx.delayFeed);
            set('fx-delay-mix',fx.delayMix); set('fx-delay-mix-val',fx.delayMix);
            set('fx-reverb',fx.reverb); set('fx-reverb-val',fx.reverb);
            document.getElementById('filter-type-btn').innerText = fx.filterType==='lowpass'?'LowPass':'HighPass';
        }
        function toggleFilterType(){ if(state.currentConfigId!=null){ const fx=state.pads[state.currentConfigId].fx; fx.filterType=fx.filterType==='lowpass'?'highpass':'lowpass'; updateFxUi(fx); } }

        function renderEqSliders(pad) {
            const c = document.getElementById('eq-container'); c.innerHTML = '';
            const l = document.getElementById('eq-labels'); l.innerHTML = '';
            FREQUENCIES.forEach((f, i) => {
                const w = document.createElement('div'); w.className = "flex justify-center h-full items-end pb-0";
                const s = document.createElement('input'); s.type='range'; s.className='vertical-slider'; s.min=-20; s.max=20; s.step=1; s.value=pad.eqGains[i];
                s.oninput = (e) => pad.eqGains[i] = parseInt(e.target.value);
                w.appendChild(s); c.appendChild(w);
                const lbl = document.createElement('span'); lbl.className = "text-[9px] text-gray-500 transform -rotate-45 origin-center mt-2 font-mono";
                lbl.innerText = f>=1000 ? `${f/1000}k` : f; l.appendChild(lbl);
            });
            const t = document.getElementById('eq-toggle');
            if(pad.eqEnabled) { t.className="text-[10px] px-3 py-1 rounded-full bg-green-500 text-white font-bold transition"; c.classList.remove('opacity-40', 'pointer-events-none'); }
            else { t.className="text-[10px] px-3 py-1 rounded-full bg-gray-300 text-white font-bold transition"; c.classList.add('opacity-40', 'pointer-events-none'); }
        }
        function toggleEq() { if(state.currentConfigId!=null) { const p=state.pads[state.currentConfigId]; p.eqEnabled=!p.eqEnabled; renderEqSliders(p); } }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); renderSettingsList(); selectSettingsItem('general'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        function renderSettingsList() {
            const list = document.getElementById('settings-pad-list');
            list.innerHTML = '';
            const general = document.createElement('div');
            general.className = `p-3 rounded-lg cursor-pointer font-bold text-sm mb-1 text-gray-700 bg-gray-200`;
            general.innerText = "General Settings";
            general.id = 'list-item-general';
            general.onclick = () => selectSettingsItem('general');
            list.appendChild(general);
            for(let i=0; i<state.rows*state.cols; i++) {
                const pad = state.pads[i];
                const item = document.createElement('div');
                item.className = `p-2 rounded-lg cursor-pointer flex items-center justify-between text-xs font-bold transition mb-1 bg-white hover:bg-gray-100 text-gray-600 border border-transparent`;
                item.onclick = () => selectSettingsItem('pad', i);
                item.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden w-full">
                        <span class="w-5 h-5 flex-shrink-0 rounded-full bg-gray-200 flex items-center justify-center text-[10px]">${i+1}</span>
                        <span class="truncate">${pad.name}</span>
                    </div>
                    ${pad.buffer ? '<i class="fa-solid fa-music text-green-500 text-[10px] ml-2 flex-shrink-0"></i>' : ''}
                `;
                item.id = `pad-list-item-${i}`;
                list.appendChild(item);
            }
        }

        function selectSettingsItem(type, id) {
            document.getElementById('general-config-area').classList.add('hidden');
            document.getElementById('pad-config-area').classList.add('hidden');
            document.getElementById('config-empty').classList.add('hidden');
            
            const generalItem = document.getElementById('list-item-general');
            if(generalItem) generalItem.className = "p-3 rounded-lg cursor-pointer font-bold text-sm mb-1 text-gray-700 bg-gray-200";
            for(let i=0; i<MAX_PADS; i++) {
                const el = document.getElementById(`pad-list-item-${i}`);
                if(el) el.className = "p-2 rounded-lg cursor-pointer flex items-center justify-between text-xs font-bold transition mb-1 bg-white hover:bg-gray-100 text-gray-600 border border-transparent";
            }

            if (type === 'general') {
                if(generalItem) generalItem.className = "p-3 rounded-lg cursor-pointer font-bold text-sm mb-1 text-white bg-gray-600 shadow";
                document.getElementById('general-config-area').classList.remove('hidden');
            } else {
                state.currentConfigId = id;
                const item = document.getElementById(`pad-list-item-${id}`);
                if(item) item.className = "p-2 rounded-lg cursor-pointer flex items-center justify-between text-xs font-bold transition mb-1 bg-green-50 text-green-700 border border-green-200 shadow-sm";
                document.getElementById('pad-config-area').classList.remove('hidden');
                
                const pad = state.pads[id];
                document.getElementById('config-pad-title').innerText = `Pad ${id+1}`;
                document.getElementById('config-current-filename').innerText = pad.fileName || "No file loaded";
                document.getElementById('config-name').value = pad.name;
                document.getElementById('config-keybind').value = pad.keyBind || "";
                
                updatePadVolume(pad.volume);
                updatePadBpm(pad.playbackRate);
                updatePadPitch(pad.pitch);
                updateLoopUi(pad.loop);
                updateReverseUi(pad.reverse);
                updateToggleModeUi(pad.toggleMode);
                updateHoldModeUi(pad.holdMode);
                updateEffectStateUi(pad.effectsEnabled);
                updateFxUi(pad.fx);
                setPlayMode(pad.playMode);

                const lockBtn = document.getElementById('lock-toggle');
                if(pad.isLocked) {
                    lockBtn.classList.remove('toggle-inactive'); lockBtn.classList.add('toggle-active');
                    lockBtn.querySelector('.toggle-knob').style.transform = "translateX(1.25rem)";
                } else {
                    lockBtn.classList.remove('toggle-active'); lockBtn.classList.add('toggle-inactive');
                    lockBtn.querySelector('.toggle-knob').style.transform = "translateX(0)";
                }
                document.getElementById('trim-start').value = formatTime(pad.trimStart);
                document.getElementById('trim-end').value = pad.trimEnd ? formatTime(pad.trimEnd) : "";
                renderEqSliders(pad);
            }
        }

        function updateGridDim(d, v) { let n=state[d]+v; if(d==='rows'){if(n<1)n=1;if(n>5)n=5;}else{if(n<1)n=1;if(n>5)n=5;} state[d]=n; renderPads(); renderSettingsList(); }
        function toggleFullscreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        document.addEventListener('fullscreenchange', () => {
            const warningBtn = document.getElementById('warning-fs-btn');
            const panelBtnIcon = document.querySelector('#panel-fs-btn i');
            if (document.fullscreenElement) {
                warningBtn.innerText = "Exit Fullscreen";
                panelBtnIcon.className = "fa-solid fa-compress text-lg";
            } else {
                warningBtn.innerText = "Enter Fullscreen";
                panelBtnIcon.className = "fa-solid fa-expand text-lg";
            }
        });

        function toggleKeyboardControl() { 
            state.keyboardEnabled = !state.keyboardEnabled; 
            const b=document.getElementById('kb-toggle'); 
            if(state.keyboardEnabled){ b.classList.remove('toggle-inactive'); b.classList.add('toggle-active'); b.querySelector('.toggle-knob').style.transform="translateX(1.25rem)"; }
            else{ b.classList.remove('toggle-active'); b.classList.add('toggle-inactive'); b.querySelector('.toggle-knob').style.transform="translateX(0)"; }
        }
        function updateMasterVolume(v){ 
            state.masterVolume = parseInt(v); 
            document.getElementById('master-vol-display').innerText = `${v}%`; 
            document.getElementById('master-volume').value = v; 
            if(masterGain) masterGain.gain.value = v/100; 
        }
        function toggleLayout() { state.isRightLayout = !state.isRightLayout; const c = document.getElementById('app-container'); const p = document.getElementById('controls-area'); if(state.isRightLayout) { c.classList.remove('layout-reverse'); p.classList.remove('border-r'); p.classList.add('border-l'); } else { c.classList.add('layout-reverse'); p.classList.remove('border-l'); p.classList.add('border-r'); } }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); }

        function renderPads() {
            const grid = document.getElementById('pads-grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${state.cols}, minmax(0, 1fr))`;
            grid.style.gridTemplateRows = `repeat(${state.rows}, minmax(0, 1fr))`;
            const total = state.rows * state.cols;
            for(let i=0; i<total; i++) {
                const pad = state.pads[i];
                const div = document.createElement('div'); div.className = "w-full h-full";
                const surf = document.createElement('div'); surf.id = `pad-surface-${i}`;
                let cls = "pad-surface flex flex-col justify-between p-2 relative";
                if(pad.isLocked) cls += " locked";
                surf.className = cls;
                
                const badges = `<div class="badge-container"><span class="badge badge-solo">S</span><span class="badge badge-effect">E</span></div>`;
                const num = `<span class="absolute bottom-1 right-2 text-gray-300 font-bold text-xl pointer-events-none select-none z-0">${i+1}</span>`;
                const name = `<div class="absolute bottom-1 left-4 right-12 z-10 flex items-center justify-center"><p class="text-[11px] text-gray-600 font-bold truncate w-full text-center" title="${pad.name}">${pad.name}</p></div>`;
                
                // Touch Listeners
                const handleDown = (e) => { 
                    if(e.cancelable) e.preventDefault(); 
                    handlePadDown(i); 
                };
                const handleUp = (e) => {
                    handlePadUp(i);
                };

                surf.innerHTML = badges + num + name;
                surf.addEventListener('mousedown', (e)=>{if(e.button===0)handleDown(e)});
                surf.addEventListener('touchstart', handleDown);
                
                surf.addEventListener('mouseup', handleUp);
                surf.addEventListener('mouseleave', handleUp); 
                surf.addEventListener('touchend', handleUp);
                surf.addEventListener('touchcancel', handleUp);
                
                div.appendChild(surf); grid.appendChild(div);
            }
            document.getElementById('disp-rows').innerText = state.rows;
            document.getElementById('disp-cols').innerText = state.cols;
        }

        function exportData(){ const d = { version: 4.6, rows: state.rows, cols: state.cols, master: state.masterVolume, pads: state.pads.map(p => { const { buffer, activeSources, _revBuffer, ...data } = p; return data; })}; const b = new Blob([JSON.stringify(d)], {type:"application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download="sampler.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(inp){ 
            const f = inp.files[0]; if(!f) return; 
            const overlay = document.getElementById('processing-overlay');
            overlay.classList.remove('hidden');
            
            const r = new FileReader(); 
            r.onload = (e) => { 
                const d = JSON.parse(e.target.result); 
                stopAllSounds(); initAudio(); 
                state.rows = d.rows||4; state.cols = d.cols||4; state.masterVolume = d.master||100; updateMasterVolume(state.masterVolume); 
                d.pads.forEach((dp, i) => { 
                    if(i < MAX_PADS) { 
                        Object.assign(state.pads[i], dp); 
                        state.pads[i].activeSources=[]; 
                        state.pads[i]._revBuffer=null; 
                        if(dp.rawBase64) { 
                            const bin = atob(dp.rawBase64); const len = bin.length; const bytes = new Uint8Array(len); for(let k=0; k<len; k++) bytes[k] = bin.charCodeAt(k); 
                            audioCtx.decodeAudioData(bytes.buffer.slice(0), b => { state.pads[i].buffer = b; renderPads(); }); 
                        } 
                    } 
                }); 
                
                overlay.classList.add('hidden');
                renderSettingsList();
                // Ensure General Settings is selected after import
                selectSettingsItem('general'); 
                renderPads();
                showToast("Loaded Successfully!");
            }; 
            r.readAsText(f); inp.value=""; 
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('settings-modal');
                if (!modal.classList.contains('hidden')) { closeSettings(); return; }
            }
            if (!state.keyboardEnabled) return; if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') { e.preventDefault(); stopAllSounds(); return; }
            if (state.activeAudioCount > 0) {
                if (e.key === 'Shift') { toggleMuteMode(); return; }
                if (e.key === 'Control') { toggleSoloMode(); return; }
                if (e.key === 'Alt') { e.preventDefault(); toggleEndMode(); return; }
                if (e.key === 'Backspace') { e.preventDefault(); toggleEffectMode(); return; } 
                if (e.code === 'ArrowUp' || e.code === 'ArrowRight') { updateMasterVolume(Math.min(200, state.masterVolume + 5)); return; }
                if (e.code === 'ArrowDown' || e.code === 'ArrowLeft') { updateMasterVolume(Math.max(0, state.masterVolume - 5)); return; }
            }
            const key = e.key.toUpperCase(); const pad = state.pads.find(p => p.keyBind === key); 
            if (pad) { 
                e.preventDefault(); 
                if (!e.repeat) handlePadDown(pad.id); 
            }
        });

        document.addEventListener('keyup', (e) => {
             if (!state.keyboardEnabled) return; if (e.target.tagName === 'INPUT') return;
             const key = e.key.toUpperCase(); const pad = state.pads.find(p => p.keyBind === key); 
             if (pad) { handlePadUp(pad.id); }
        });

        window.onload = () => { renderPads(); };
    </script>
</body>
</html>
