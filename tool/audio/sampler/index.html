<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Sampler Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        body {
            background-color: #ffffff;
            color: #333;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden; /* No Scroll */
            user-select: none;
        }

        /* Screen Size Blocker Logic (Updated to 480x390) */
        #size-warning {
            display: none;
        }
        /* Width < 480px OR Height < 390px triggers warning */
        @media (max-width: 479px), (max-height: 389px) {
            #size-warning {
                display: flex !important;
            }
        }

        /* Range Slider Customization */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #22c55e;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }

        /* Vertical Slider for EQ */
        input[type=range].vertical-slider {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* Webkit */
            width: 8px;
            height: 100%; /* Fill container height */
            padding: 0 5px;
            background: transparent;
        }

        /* Pad Styles */
        .pad-surface {
            transition: all 0.1s ease;
            position: relative;
            background-color: white;
            border: 3px solid #22c55e; /* Green border */
            border-radius: 8px;
            cursor: pointer;
            touch-action: manipulation;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .pad-surface:active {
            transform: scale(0.96);
            background-color: #f0fdf4;
        }
        .pad-surface.playing {
            border-color: #ec4899; /* Pink border */
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
            background-color: #fff1f2;
        }
        .pad-surface.locked {
            opacity: 0.6;
            background-color: #f3f4f6;
            cursor: not-allowed;
            border-color: #d1d5db;
        }

        /* Layout Utilities */
        .layout-normal { flex-direction: row; }
        .layout-reverse { flex-direction: row-reverse; }

        .controls-disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* Toast Notification */
        .toast {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            transform: translateY(150%) translateX(-50%);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0) translateX(-50%);
            opacity: 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* EQ Grid Background */
        .eq-grid {
            background: linear-gradient(to bottom, 
                #e5e7eb 1px, transparent 1px, transparent calc(25% - 1px),
                #e5e7eb 1px, transparent 1px, transparent calc(50% - 1px),
                #9ca3af 1px, transparent 1px, transparent calc(75% - 1px),
                #e5e7eb 1px, transparent 1px, transparent 100%
            );
            background-size: 100% 100%;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <!-- Size Warning Overlay -->
    <div id="size-warning" class="fixed inset-0 bg-gray-800 z-[9999] flex flex-col items-center justify-center text-white p-6 text-center">
        <i class="fa-solid fa-display text-5xl mb-4 text-red-400"></i>
        <h2 class="text-2xl font-bold mb-2">Screen Size Too Small</h2>
        <p class="text-sm text-gray-400 mt-2">Minimum required: 480px x 390px</p>
    </div>

    <!-- App Container -->
    <div id="app-container" class="flex flex-grow w-full h-full layout-normal overflow-hidden">
        
        <!-- Pads Area (Left) -->
        <div class="flex-grow bg-white flex flex-col items-center justify-center p-3 h-full overflow-hidden">
            <!-- Grid container adapts dynamically via JS -->
            <div id="pads-grid" class="grid gap-3 w-full h-full max-w-6xl">
                <!-- Pads generated via JS -->
            </div>
        </div>

        <!-- Controls Area (Right) -->
        <div id="controls-area" class="w-60 min-w-[240px] bg-white border-l border-gray-200 flex flex-col justify-between p-4 shadow-xl z-20 relative h-full">
            
            <!-- Top: Title & Tools -->
            <div class="flex flex-col gap-4 w-full">
                <h1 class="text-xl font-bold text-gray-800 text-center tracking-tight border-b pb-3">Web Sampler Pro</h1>
                
                <div id="non-essential-controls" class="flex flex-col gap-4 transition-opacity duration-200">
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-3">
                        <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition shadow-sm" title="Settings">
                            <i class="fa-solid fa-gear text-lg"></i>
                        </button>
                        <button onclick="toggleLayout()" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition shadow-sm" title="Swap Layout">
                            <i class="fa-solid fa-arrow-right-arrow-left text-lg"></i>
                        </button>
                    </div>

                    <!-- Grid Controls (Rows & Cols) -->
                    <div class="flex flex-col gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-gray-500 font-bold uppercase w-8">Rows</span>
                            <div class="flex items-center gap-2">
                                <button onclick="updateGridDim('rows', -1)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center text-xs text-gray-600 shadow-sm"><i class="fa-solid fa-minus"></i></button>
                                <span id="disp-rows" class="text-xs font-bold w-4 text-center">4</span>
                                <button onclick="updateGridDim('rows', 1)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center text-xs text-gray-600 shadow-sm"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-gray-500 font-bold uppercase w-8">Cols</span>
                            <div class="flex items-center gap-2">
                                <button onclick="updateGridDim('cols', -1)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center text-xs text-gray-600 shadow-sm"><i class="fa-solid fa-minus"></i></button>
                                <span id="disp-cols" class="text-xs font-bold w-4 text-center">4</span>
                                <button onclick="updateGridDim('cols', 1)" class="w-6 h-6 rounded bg-white border hover:bg-gray-100 flex items-center justify-center text-xs text-gray-600 shadow-sm"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Import/Export -->
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded text-xs hover:bg-blue-100 font-bold transition flex items-center justify-center shadow-sm">
                            <i class="fa-solid fa-download mr-2"></i> Export
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex-1 py-2 bg-purple-50 text-purple-600 rounded text-xs hover:bg-purple-100 font-bold transition flex items-center justify-center shadow-sm">
                            <i class="fa-solid fa-upload mr-2"></i> Import
                        </button>
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                    </div>
                </div>
            </div>

            <!-- Bottom: Play Control & Master Volume -->
            <div class="flex flex-col gap-4 mt-auto pt-4 border-t border-gray-100">
                <button onclick="stopAllSounds()" class="w-full py-3 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold shadow-md transition flex items-center justify-center gap-2 text-sm active:scale-95">
                    <i class="fa-solid fa-square"></i> ALL STOP
                </button>

                <div>
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-bold">
                        <span>MASTER VOL</span>
                        <span id="master-vol-display">100%</span>
                    </div>
                    <input type="range" id="master-volume" min="0" max="200" value="100" oninput="updateMasterVolume(this.value)" class="w-full">
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white w-[90vw] max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden animate-fade-in-up">
            
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-gray-700 flex items-center"><i class="fa-solid fa-sliders mr-2"></i> Pad Settings</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex flex-grow overflow-hidden">
                <!-- Left: Pad List -->
                <div class="w-1/4 min-w-[160px] border-r bg-gray-50 overflow-y-auto p-2">
                    <div id="settings-pad-list" class="space-y-1"></div>
                </div>

                <!-- Right: Config Form -->
                <div class="flex-grow p-6 overflow-y-auto relative bg-white">
                    <div id="pad-config-area" class="hidden space-y-6">
                        
                        <!-- Header -->
                        <div class="flex justify-between items-center border-b pb-4">
                            <div>
                                <h3 id="config-pad-title" class="text-2xl font-bold text-green-600">Pad 1</h3>
                                <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                    <span id="config-current-filename" class="font-mono bg-gray-100 px-2 py-0.5 rounded truncate max-w-[250px] block">No file loaded</span>
                                </div>
                            </div>
                            <!-- Lock Switch -->
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-gray-600 uppercase">Lock Pad</span>
                                <button id="lock-toggle" onclick="togglePadLock()" class="w-12 h-6 rounded-full bg-gray-300 relative transition-colors duration-200 focus:outline-none">
                                    <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform duration-200 shadow-sm"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Config Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Col 1: Basic -->
                            <div class="space-y-4">
                                <!-- Upload & Name -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Source & Name</label>
                                    <div class="flex items-center gap-2 mb-3">
                                        <label class="cursor-pointer bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold transition shadow-sm flex items-center hover:shadow">
                                            <i class="fa-solid fa-upload mr-2"></i> Upload Audio
                                            <input type="file" accept="audio/*" class="hidden" onchange="handleAudioUpload(this)">
                                        </label>
                                        <span id="upload-status" class="text-xs text-red-500 font-bold hidden bg-red-50 px-2 py-1 rounded">Upload Failed</span>
                                    </div>
                                    <input type="text" id="config-name" oninput="updatePadName(this.value)" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500" placeholder="Enter Pad Name">
                                </div>

                                <!-- Volume & Mode -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-gray-700 uppercase">Default Volume</label>
                                        <span id="config-vol-display" class="text-xs font-mono bg-white px-2 py-1 rounded border">100%</span>
                                    </div>
                                    <div class="flex items-center gap-3 mb-4">
                                        <button onclick="adjustPadVolume(-10)" class="w-8 h-8 rounded-full bg-white border hover:bg-gray-100 flex items-center justify-center transition"><i class="fa-solid fa-minus text-xs"></i></button>
                                        <input type="range" id="config-vol" min="0" max="200" value="100" oninput="updatePadVolume(this.value)" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <button onclick="adjustPadVolume(10)" class="w-8 h-8 rounded-full bg-white border hover:bg-gray-100 flex items-center justify-center transition"><i class="fa-solid fa-plus text-xs"></i></button>
                                    </div>

                                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Play Mode</label>
                                    <div class="flex rounded-md border border-gray-200 bg-white overflow-hidden shadow-sm">
                                        <button onclick="setPlayMode('poly')" id="mode-poly" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 border-r transition">Poly</button>
                                        <button onclick="setPlayMode('mono')" id="mode-mono" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 border-r transition">Mono</button>
                                        <button onclick="setPlayMode('solo')" id="mode-solo" class="flex-1 py-2 text-xs font-bold hover:bg-gray-50 transition">Solo</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 2: Advanced -->
                            <div class="space-y-4">
                                <!-- Trimming -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Trimming (MM:SS.mmm)</label>
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <span class="text-[10px] text-gray-500 font-bold">Start Time</span>
                                            <input type="text" id="trim-start" placeholder="0:00.000" onchange="updateTrim()" class="w-full border border-gray-300 rounded px-2 py-1.5 text-center font-mono text-sm mt-1 focus:border-green-500 focus:outline-none">
                                        </div>
                                        <div class="flex-1">
                                            <span class="text-[10px] text-gray-500 font-bold">End Time</span>
                                            <input type="text" id="trim-end" placeholder="End" onchange="updateTrim()" class="w-full border border-gray-300 rounded px-2 py-1.5 text-center font-mono text-sm mt-1 focus:border-green-500 focus:outline-none">
                                        </div>
                                    </div>
                                </div>

                                <!-- EQ -->
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <div class="flex justify-between items-center mb-4">
                                        <label class="text-xs font-bold text-gray-700 uppercase">9-Band Equalizer</label>
                                        <button id="eq-toggle" onclick="toggleEq()" class="text-[10px] px-3 py-1 rounded-full bg-gray-300 text-white font-bold transition">OFF</button>
                                    </div>
                                    
                                    <div class="relative h-40 w-full">
                                        <!-- Scale Labels (Left) -->
                                        <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-[9px] text-gray-400 font-mono pointer-events-none pr-1 w-8 text-right z-10">
                                            <span>+20</span>
                                            <span>+10</span>
                                            <span>0dB</span>
                                            <span>-10</span>
                                            <span>-20</span>
                                        </div>
                                        
                                        <!-- Sliders Container -->
                                        <div id="eq-container" class="ml-8 grid grid-cols-9 gap-1 h-full items-end opacity-50 pointer-events-none transition-opacity eq-grid relative border border-gray-200 bg-white rounded">
                                            <!-- Sliders generated by JS -->
                                        </div>
                                    </div>
                                    
                                    <div id="eq-labels" class="ml-8 grid grid-cols-9 gap-1 mt-1 text-center">
                                        <!-- Labels generated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="config-empty" class="h-full flex flex-col items-center justify-center text-gray-300">
                        <i class="fa-solid fa-arrow-left-long text-4xl mb-4"></i>
                        <p class="font-bold text-lg">Select a pad to configure</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 toast font-bold text-sm pointer-events-none flex items-center gap-2">
        <i class="fa-solid fa-circle-info"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- Configuration ---
        const FREQUENCIES = [62, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
        const MAX_PADS = 20; // 4 rows * 5 cols max
        
        const state = {
            rows: 4,
            cols: 4,
            masterVolume: 100,
            isRightLayout: true,
            pads: [],
            activeAudioCount: 0,
            currentConfigId: null
        };

        let audioCtx = null;
        let masterGain = null;

        // Initialize State
        for(let i=0; i<MAX_PADS; i++) {
            state.pads.push({
                id: i,
                name: `Pad ${i + 1}`,
                buffer: null,
                rawBase64: null,
                fileName: "",
                volume: 100,
                isLocked: false,
                playMode: 'poly',
                trimStart: 0,
                trimEnd: null,
                eqEnabled: false,
                eqGains: new Array(9).fill(0), // dB value (-20 to 20)
                activeSources: []
            });
        }

        // --- Audio Core ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                updateMasterVolumeState();
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(padId) {
            initAudio();
            const pad = state.pads[padId];
            if (pad.isLocked || !pad.buffer) return;

            if (pad.playMode === 'solo') stopAllSounds();
            else if (pad.playMode === 'mono') stopPad(padId);

            const source = audioCtx.createBufferSource();
            source.buffer = pad.buffer;
            const padGain = audioCtx.createGain();
            padGain.gain.value = pad.volume / 100;

            let inputNode = source;
            const filters = [];
            
            // Apply EQ
            if (pad.eqEnabled) {
                FREQUENCIES.forEach((freq, idx) => {
                    const filter = audioCtx.createBiquadFilter();
                    if (idx === 0) filter.type = 'lowshelf';
                    else if (idx === FREQUENCIES.length - 1) filter.type = 'highshelf';
                    else filter.type = 'peaking';
                    
                    filter.frequency.value = freq;
                    filter.gain.value = pad.eqGains[idx];
                    filter.Q.value = 1.0;
                    
                    inputNode.connect(filter);
                    inputNode = filter;
                    filters.push(filter);
                });
            }

            inputNode.connect(padGain);
            padGain.connect(masterGain);

            // Trimming
            const duration = pad.buffer.duration;
            let start = pad.trimStart || 0;
            let end = pad.trimEnd !== null ? pad.trimEnd : duration;
            if (end > duration) end = duration;
            if (start >= end) start = 0;

            source.start(0, start, end - start);
            
            const sourceObj = { source, padGain, filters };
            pad.activeSources.push(sourceObj);
            
            updatePlayState(padId, true);
            source.onended = () => {
                pad.activeSources = pad.activeSources.filter(s => s !== sourceObj);
                if (pad.activeSources.length === 0) updatePlayState(padId, false);
            };
        }

        function stopPad(padId) {
            const pad = state.pads[padId];
            pad.activeSources.forEach(s => { try { s.source.stop(); } catch(e){} });
            pad.activeSources = [];
            updatePlayState(padId, false);
        }

        function stopAllSounds() {
            state.pads.forEach(p => stopPad(p.id));
        }

        function updatePlayState(padId, isPlaying) {
            const el = document.getElementById(`pad-surface-${padId}`);
            if(el) {
                if (isPlaying) {
                    el.classList.add('playing');
                } else {
                    if(state.pads[padId].activeSources.length === 0) {
                        el.classList.remove('playing');
                    }
                }
            }
            // Recalculate total playing for controls disable
            const totalPlaying = state.pads.reduce((acc, p) => acc + p.activeSources.length, 0);
            updateControlsState(totalPlaying > 0);
        }

        function updateControlsState(isPlaying) {
            const controls = document.getElementById('non-essential-controls');
            if (isPlaying) controls.classList.add('controls-disabled');
            else controls.classList.remove('controls-disabled');
        }

        function updateMasterVolumeState() {
            if(masterGain) masterGain.gain.value = state.masterVolume / 100;
        }

        // --- UI Rendering ---
        function renderPads() {
            const grid = document.getElementById('pads-grid');
            grid.innerHTML = '';

            // Dynamic grid columns/rows
            grid.style.gridTemplateColumns = `repeat(${state.cols}, minmax(0, 1fr))`;
            grid.style.gridTemplateRows = `repeat(${state.rows}, minmax(0, 1fr))`;

            const totalPads = state.rows * state.cols;

            for(let i=0; i < totalPads; i++) {
                const pad = state.pads[i];
                
                const container = document.createElement('div');
                container.className = "w-full h-full"; 

                // Pad Surface
                const padSurface = document.createElement('div');
                padSurface.id = `pad-surface-${i}`;
                padSurface.className = `pad-surface flex flex-col justify-between p-2 relative ${pad.isLocked ? 'locked' : ''}`;
                
                // Number (Bottom Right)
                const number = document.createElement('span');
                number.className = "absolute bottom-1 right-2 text-gray-300 font-bold text-xl pointer-events-none select-none z-0";
                number.innerText = i + 1;

                // Lock Icon
                const lockIcon = pad.isLocked ? '<i class="fa-solid fa-lock absolute top-2 right-2 text-gray-400 text-sm z-10"></i>' : '';

                // Name (Inside Bottom) - With padding-right to avoid overlap with number
                const nameLabel = document.createElement('div');
                nameLabel.className = "absolute bottom-1 left-0 w-full text-center pl-1 pr-8 z-10";
                nameLabel.innerHTML = `<p class="text-[11px] text-gray-600 font-bold truncate" title="${pad.name}">${pad.name}</p>`;

                padSurface.innerHTML = `${lockIcon}`;
                padSurface.appendChild(number);
                padSurface.appendChild(nameLabel);

                // Events
                const trigger = (e) => {
                    if(e.cancelable) e.preventDefault();
                    playSound(i);
                };
                padSurface.addEventListener('mousedown', (e) => { if(e.button===0) trigger(e); });
                padSurface.addEventListener('touchstart', trigger);

                container.appendChild(padSurface);
                grid.appendChild(container);
            }

            // Update display counters
            document.getElementById('disp-rows').innerText = state.rows;
            document.getElementById('disp-cols').innerText = state.cols;
        }

        function toggleLayout() {
            state.isRightLayout = !state.isRightLayout;
            const container = document.getElementById('app-container');
            const controls = document.getElementById('controls-area');
            if (state.isRightLayout) {
                container.classList.remove('layout-reverse');
                container.classList.add('layout-normal');
                controls.classList.remove('border-r');
                controls.classList.add('border-l');
            } else {
                container.classList.remove('layout-normal');
                container.classList.add('layout-reverse');
                controls.classList.remove('border-l');
                controls.classList.add('border-r');
            }
        }

        function updateGridDim(dim, delta) {
            let newVal = state[dim] + delta;
            
            // Constraints
            if (dim === 'rows') {
                if (newVal < 1) newVal = 1;
                if (newVal > 4) newVal = 4;
            } else if (dim === 'cols') {
                if (newVal < 2) newVal = 2;
                if (newVal > 5) newVal = 5;
            }
            
            state[dim] = newVal;
            renderPads();
        }

        function updateMasterVolume(val) {
            state.masterVolume = parseInt(val);
            document.getElementById('master-vol-display').innerText = `${val}%`;
            updateMasterVolumeState();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // --- Settings Logic ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsList();
            if(state.currentConfigId === null || state.currentConfigId >= state.rows * state.cols) {
                selectConfigPad(0);
            } else {
                selectConfigPad(state.currentConfigId);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function renderSettingsList() {
            const list = document.getElementById('settings-pad-list');
            list.innerHTML = '';
            
            const totalPads = state.rows * state.cols;

            for(let i=0; i<totalPads; i++) {
                const pad = state.pads[i];
                const isSelected = state.currentConfigId === i;
                
                const item = document.createElement('div');
                item.className = `p-2 rounded-lg cursor-pointer flex items-center justify-between text-xs font-bold transition mb-1 ${isSelected ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-white hover:bg-gray-100 text-gray-600 border border-transparent'}`;
                item.onclick = () => selectConfigPad(i);
                
                item.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="w-5 h-5 rounded-full ${isSelected ? 'bg-green-200' : 'bg-gray-200'} flex items-center justify-center text-[10px]">${i+1}</span>
                        <span class="truncate">${pad.name}</span>
                    </div>
                    ${pad.buffer ? '<i class="fa-solid fa-music text-green-500 text-[10px]"></i>' : '<i class="fa-solid fa-circle text-gray-200 text-[8px]"></i>'}
                `;
                list.appendChild(item);
            }
        }

        function selectConfigPad(id) {
            state.currentConfigId = id;
            renderSettingsList();
            
            const pad = state.pads[id];
            document.getElementById('pad-config-area').classList.remove('hidden');
            document.getElementById('config-empty').classList.add('hidden');

            // Populate Fields
            document.getElementById('config-pad-title').innerText = `Pad ${id+1}`;
            document.getElementById('config-current-filename').innerText = pad.fileName || "No file loaded";
            document.getElementById('config-name').value = pad.name;
            document.getElementById('config-vol').value = pad.volume;
            document.getElementById('config-vol-display').innerText = `${pad.volume}%`;

            // Lock Switch
            const lockBtn = document.getElementById('lock-toggle');
            const knob = lockBtn.querySelector('span');
            if(pad.isLocked) {
                lockBtn.className = "w-12 h-6 rounded-full bg-green-500 relative transition-colors duration-200";
                knob.style.transform = "translateX(24px)";
            } else {
                lockBtn.className = "w-12 h-6 rounded-full bg-gray-300 relative transition-colors duration-200";
                knob.style.transform = "translateX(0)";
            }

            // Play Mode
            ['poly', 'mono', 'solo'].forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                if(pad.playMode === m) btn.className = "flex-1 py-2 text-xs font-bold bg-green-500 text-white shadow-inner transition";
                else btn.className = "flex-1 py-2 text-xs font-bold bg-white text-gray-600 hover:bg-gray-50 transition border-r last:border-0";
            });

            // Trim
            document.getElementById('trim-start').value = formatTime(pad.trimStart);
            document.getElementById('trim-end').value = pad.trimEnd ? formatTime(pad.trimEnd) : "";

            // EQ
            renderEqSliders(pad);
        }

        function handleAudioUpload(input) {
            const file = input.files[0];
            const status = document.getElementById('upload-status');
            if(!file) return;
            status.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                initAudio();
                const arrayBuffer = e.target.result;
                // Convert to base64 for export
                const bytes = new Uint8Array(arrayBuffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                const base64 = btoa(binary);

                audioCtx.decodeAudioData(arrayBuffer.slice(0), (buffer) => {
                    const pad = state.pads[state.currentConfigId];
                    pad.buffer = buffer;
                    pad.rawBase64 = base64;
                    pad.fileName = file.name;
                    pad.name = file.name.replace(/\.[^/.]+$/, "");
                    selectConfigPad(state.currentConfigId);
                    renderPads();
                }, (err) => {
                    console.error(err);
                    status.classList.remove('hidden');
                    setTimeout(() => status.classList.add('hidden'), 3000);
                });
            };
            reader.readAsArrayBuffer(file);
            input.value = "";
        }

        function updatePadName(val) {
            if(state.currentConfigId === null) return;
            state.pads[state.currentConfigId].name = val;
            renderPads();
            // Update list item
            renderSettingsList();
        }

        function updatePadVolume(val) {
            if(state.currentConfigId === null) return;
            const v = parseInt(val);
            state.pads[state.currentConfigId].volume = v;
            document.getElementById('config-vol-display').innerText = `${v}%`;
            document.getElementById('config-vol').value = v;
        }

        function adjustPadVolume(delta) {
            const pad = state.pads[state.currentConfigId];
            let next = pad.volume + delta;
            if(next < 0) next = 0;
            if(next > 200) next = 200;
            updatePadVolume(next);
        }

        function togglePadLock() {
            if(state.currentConfigId === null) return;
            const pad = state.pads[state.currentConfigId];
            pad.isLocked = !pad.isLocked;
            selectConfigPad(state.currentConfigId);
            renderPads();
        }

        function setPlayMode(mode) {
            if(state.currentConfigId === null) return;
            state.pads[state.currentConfigId].playMode = mode;
            selectConfigPad(state.currentConfigId);
        }

        function parseTime(str) {
            if(!str) return null;
            if(str.includes(':')) {
                const [m, s] = str.split(':');
                return (parseFloat(m)||0)*60 + (parseFloat(s)||0);
            }
            return parseFloat(str);
        }

        function formatTime(sec) {
            if(sec === null || isNaN(sec)) return "";
            const m = Math.floor(sec / 60);
            const s = (sec % 60).toFixed(3).replace(/\.000$/, "");
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updateTrim() {
            if(state.currentConfigId === null) return;
            state.pads[state.currentConfigId].trimStart = parseTime(document.getElementById('trim-start').value) || 0;
            state.pads[state.currentConfigId].trimEnd = parseTime(document.getElementById('trim-end').value);
        }

        // --- EQ ---
        function renderEqSliders(pad) {
            const container = document.getElementById('eq-container');
            const labels = document.getElementById('eq-labels');
            const toggle = document.getElementById('eq-toggle');

            if(pad.eqEnabled) {
                toggle.className = "text-[10px] px-3 py-1 rounded-full bg-green-500 text-white font-bold transition shadow";
                toggle.innerText = "ON";
                container.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                toggle.className = "text-[10px] px-3 py-1 rounded-full bg-gray-300 text-white font-bold transition";
                toggle.innerText = "OFF";
                container.classList.add('opacity-50', 'pointer-events-none');
            }

            container.innerHTML = ''; 
            labels.innerHTML = '';

            FREQUENCIES.forEach((freq, idx) => {
                // Slider Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = "flex justify-center h-full pt-2 pb-2";

                // Input
                const s = document.createElement('input');
                s.type = 'range'; 
                s.className = 'vertical-slider';
                s.min = -20; 
                s.max = 20; 
                s.step = 1; 
                s.value = pad.eqGains[idx];
                
                s.oninput = (e) => {
                    pad.eqGains[idx] = parseInt(e.target.value);
                };

                wrapper.appendChild(s);
                container.appendChild(wrapper);

                // Label
                const l = document.createElement('span');
                l.className = "text-[9px] text-gray-500 transform -rotate-45 origin-center mt-2 font-mono";
                l.innerText = freq >= 1000 ? `${freq/1000}k` : freq;
                labels.appendChild(l);
            });
        }

        function toggleEq() {
            if(state.currentConfigId === null) return;
            const pad = state.pads[state.currentConfigId];
            pad.eqEnabled = !pad.eqEnabled;
            renderEqSliders(pad);
        }

        // --- IO ---
        function exportData() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0,19).replace(/T/g, '_').replace(/:/g, '-');
            const fileName = `WebSamplerPro_${dateStr}.json`;

            const data = {
                version: 1.2,
                rows: state.rows,
                cols: state.cols,
                masterVolume: state.masterVolume,
                pads: state.pads.map(p => ({
                    id: p.id, name: p.name, volume: p.volume, isLocked: p.isLocked, playMode: p.playMode,
                    trimStart: p.trimStart, trimEnd: p.trimEnd, eqEnabled: p.eqEnabled, eqGains: p.eqGains,
                    fileName: p.fileName, rawBase64: p.rawBase64
                }))
            };

            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast("Export Complete");
        }

        function importData(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    stopAllSounds(); 
                    initAudio();
                    
                    // Restore grid config
                    if(d.rows && d.cols) {
                        state.rows = d.rows;
                        state.cols = d.cols;
                    } else if (d.padCount) {
                        // Fallback logic for old version imports
                        if(d.padCount === 8) { state.rows=2; state.cols=4; }
                        else if(d.padCount === 12) { state.rows=3; state.cols=4; }
                        else { state.rows=4; state.cols=4; }
                    }
                    
                    updateMasterVolume(d.masterVolume || 100);
                    document.getElementById('master-volume').value = d.masterVolume || 100;
                    
                    let pending = 0;
                    d.pads.forEach((pd, i) => {
                        if(i >= MAX_PADS) return;
                        const p = state.pads[i];
                        p.name = pd.name; 
                        p.volume = pd.volume;
                        p.isLocked = pd.isLocked; 
                        p.playMode = pd.playMode || 'poly';
                        p.trimStart = pd.trimStart; 
                        p.trimEnd = pd.trimEnd;
                        p.eqEnabled = pd.eqEnabled; 
                        p.eqGains = pd.eqGains || new Array(9).fill(0);
                        p.fileName = pd.fileName; 
                        p.rawBase64 = pd.rawBase64;

                        if(p.rawBase64) {
                            pending++;
                            const bin = atob(p.rawBase64);
                            const len = bin.length;
                            const bytes = new Uint8Array(len);
                            for(let k=0; k<len; k++) bytes[k] = bin.charCodeAt(k);
                            
                            audioCtx.decodeAudioData(bytes.buffer.slice(0), (buf) => {
                                p.buffer = buf; 
                                pending--;
                                if(pending === 0) { renderPads(); showToast("Import Complete"); }
                            }, (e) => {
                                console.error("Decode error", e);
                                pending--;
                            });
                        } else {
                            p.buffer = null;
                        }
                    });
                    
                    renderPads();
                    if(pending === 0) showToast("Import Complete");

                } catch(err) { 
                    console.error(err); 
                    showToast("Import Failed"); 
                }
            };
            r.readAsText(f);
            input.value = "";
        }

        window.onload = renderPads;
    </script>
</body>
</html>
